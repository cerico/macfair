---
- name: Create claude directory
  file:
    path: "~{{ macbook_user.stdout }}/.claude"
    state: directory

- name: Create MEMORY/State directory for location persistence
  file:
    path: "~{{ macbook_user.stdout }}/.claude/MEMORY/State"
    state: directory

- name: Create hubs directory for learning hub tracking
  file:
    path: "~{{ macbook_user.stdout }}/.claude/hubs"
    state: directory

- name: Initialize hubs registry if not exists
  copy:
    content: '{"hubs":[]}'
    dest: "~{{ macbook_user.stdout }}/.claude/hubs/registry.json"
    force: no

- name: Copy CLAUDE.md
  copy:
    src: claude/config.md
    dest: ~{{ macbook_user.stdout }}/.claude/CLAUDE.md

- name: Copy ralph.md
  copy:
    src: claude/ralph.md
    dest: ~{{ macbook_user.stdout }}/.claude/ralph.md

- name: Copy Claude settings
  copy:
    src: claude/settings.json
    dest: ~{{ macbook_user.stdout }}/.claude/settings.json

- name: Copy statusline script
  copy:
    src: claude/statusline.sh
    dest: ~{{ macbook_user.stdout }}/.claude/statusline.sh
    mode: '0755'

- name: Copy Claude skills
  copy:
    src: claude/skills/
    dest: ~{{ macbook_user.stdout }}/.claude/skills/

- name: Copy Claude hooks
  copy:
    src: claude/hooks/
    dest: ~{{ macbook_user.stdout }}/.claude/hooks/
    mode: '0755'

- name: Copy Claude commands
  copy:
    src: claude/commands/
    dest: ~{{ macbook_user.stdout }}/.claude/commands/

- name: Copy Claude agents
  copy:
    src: claude/agents/
    dest: ~{{ macbook_user.stdout }}/.claude/agents/

- name: Create gemini directory
  file:
    path: "~{{ macbook_user.stdout }}/.gemini"
    state: directory

- name: Copy GEMINI.md
  copy:
    src: claude/config.md
    dest: ~{{ macbook_user.stdout }}/.gemini/GEMINI.md

- name: Install typescript-language-server for LSP plugin
  community.general.npm:
    name: "{{ item }}"
    global: true
    state: present
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  loop:
    - typescript-language-server
    - typescript

- name: Install Claude Code plugins from official marketplace
  ansible.builtin.shell: "claude plugin install {{ item }}@claude-plugins-official"
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  register: plugin_install
  changed_when: "'already installed' not in plugin_install.stdout"
  ignore_errors: true
  loop:
    - playwright
    - typescript-lsp
    - claude-md-management
    - claude-code-setup
    - hookify
    - security-guidance

- name: Create Karabiner config directory
  file:
    path: "{{ ansible_env.HOME }}/.config/karabiner"
    state: directory

- name: Copy Karabiner config
  copy:
    src: karabiner/karabiner.json
    dest: "{{ ansible_env.HOME }}/.config/karabiner/karabiner.json"
    force: yes

- name: Install/update GSD (always runs for latest)
  ansible.builtin.command: npx get-shit-done-cc@latest --global
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"

