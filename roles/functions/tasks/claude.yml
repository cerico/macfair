---
- name: Create claude directory
  file:
    path: "~{{ macbook_user.stdout }}/.claude"
    state: directory

- name: Create MEMORY/State directory for location persistence
  file:
    path: "~{{ macbook_user.stdout }}/.claude/MEMORY/State"
    state: directory

- name: Copy CLAUDE.md
  copy:
    src: claude/config.md
    dest: ~{{ macbook_user.stdout }}/.claude/CLAUDE.md

- name: Copy ralph.md
  copy:
    src: claude/ralph.md
    dest: ~{{ macbook_user.stdout }}/.claude/ralph.md

- name: Copy Claude settings
  copy:
    src: claude/settings.json
    dest: ~{{ macbook_user.stdout }}/.claude/settings.json

- name: Copy statusline script
  copy:
    src: claude/statusline.sh
    dest: ~{{ macbook_user.stdout }}/.claude/statusline.sh
    mode: '0755'

- name: Copy Claude skills
  copy:
    src: claude/skills/
    dest: ~{{ macbook_user.stdout }}/.claude/skills/

- name: Copy Claude hooks
  copy:
    src: claude/hooks/
    dest: ~{{ macbook_user.stdout }}/.claude/hooks/
    mode: '0755'

- name: Copy Claude commands
  copy:
    src: claude/commands/
    dest: ~{{ macbook_user.stdout }}/.claude/commands/

- name: Create gemini directory
  file:
    path: "~{{ macbook_user.stdout }}/.gemini"
    state: directory

- name: Copy GEMINI.md
  copy:
    src: claude/config.md
    dest: ~{{ macbook_user.stdout }}/.gemini/GEMINI.md

- name: Get list of installed MCP servers
  ansible.builtin.shell: claude mcp list 2>/dev/null || echo ""
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  register: mcp_list
  changed_when: false

- name: Add Prisma MCP server
  ansible.builtin.shell: claude mcp add -s user prisma -- npx prisma mcp
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  when: "'prisma' not in mcp_list.stdout"
  ignore_errors: true

- name: Add Semgrep MCP server
  ansible.builtin.shell: claude mcp add -s user semgrep -- semgrep mcp
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  when: "'semgrep' not in mcp_list.stdout"
  ignore_errors: true

- name: Add Playwright MCP server
  ansible.builtin.shell: claude mcp add -s user playwright -- npx @playwright/mcp@latest
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  when: "'playwright' not in mcp_list.stdout"
  ignore_errors: true

- name: Add voicemode marketplace
  ansible.builtin.shell: claude plugin marketplace add https://github.com/mbailey/claude-plugins
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  args:
    creates: "{{ ansible_env.HOME }}/.claude/plugins/marketplaces/mbailey"
  ignore_errors: true

- name: Install voicemode plugin
  ansible.builtin.shell: claude plugin install voicemode@mbailey
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  args:
    creates: "{{ ansible_env.HOME }}/.claude/plugins/cache/mbailey/voicemode"
  ignore_errors: true

- name: Install Kokoro TTS via voicemode
  ansible.builtin.shell: claude /voicemode:install kokoro
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  args:
    creates: "{{ ansible_env.HOME }}/.voicemode/services/kokoro"
  ignore_errors: true

- name: Add claude-stt marketplace
  ansible.builtin.shell: claude plugin marketplace add jarrodwatts/claude-stt
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  args:
    creates: "{{ ansible_env.HOME }}/.claude/plugins/marketplaces/jarrodwatts-claude-stt"
  ignore_errors: true

- name: Install claude-stt plugin
  ansible.builtin.shell: claude plugin install claude-stt
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  args:
    creates: "{{ ansible_env.HOME }}/.claude/plugins/cache/jarrodwatts-claude-stt/claude-stt"
  ignore_errors: true

- name: Find all claude-stt plugin version directories
  ansible.builtin.find:
    paths: "{{ ansible_env.HOME }}/.claude/plugins/cache/jarrodwatts-claude-stt/claude-stt/"
    file_type: directory
  register: claude_stt_versions
  ignore_errors: true

- name: Run claude-stt setup for each version
  ansible.builtin.shell: |
    cd {{ item.path }}
    uv run --directory . python -m claude_stt.setup --skip-hotkey-test --no-start
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
    CLAUDE_PLUGIN_ROOT: "{{ item.path }}"
  args:
    creates: "{{ item.path }}/.venv"
  loop: "{{ claude_stt_versions.files | default([]) }}"
  when: claude_stt_versions.files is defined
  ignore_errors: true

- name: Patch claude-stt hooks to use uv (all versions)
  ansible.builtin.copy:
    dest: "{{ item.path }}/hooks/hooks.json"
    content: |
      {
        "hooks": {
          "SessionStart": [
            {
              "hooks": [
                {
                  "type": "command",
                  "command": "cd ${CLAUDE_PLUGIN_ROOT} && uv run python -m claude_stt.daemon start --background 2>/dev/null",
                  "timeout": 5000
                }
              ]
            }
          ]
        }
      }
  loop: "{{ claude_stt_versions.files | default([]) }}"
  when: claude_stt_versions.files is defined

- name: claude-stt permissions reminder
  ansible.builtin.debug:
    msg: |
      ╔══════════════════════════════════════════════════════════════════╗
      ║  claude-stt requires macOS permissions (one-time setup):         ║
      ║                                                                  ║
      ║  System Settings → Privacy & Security → Accessibility            ║
      ║    → Enable your terminal (iTerm/Terminal)                       ║
      ║                                                                  ║
      ║  System Settings → Privacy & Security → Input Monitoring         ║
      ║    → Enable your terminal (iTerm/Terminal)                       ║
      ║                                                                  ║
      ║  After granting permissions, restart Claude Code.                ║
      ║  Press § to start/stop voice recording.                          ║
      ╚══════════════════════════════════════════════════════════════════╝
  when: claude_stt_versions.files is defined and claude_stt_versions.files | length > 0

- name: Create Karabiner config directory
  file:
    path: "{{ ansible_env.HOME }}/.config/karabiner"
    state: directory

- name: Copy Karabiner config
  copy:
    src: karabiner/karabiner.json
    dest: "{{ ansible_env.HOME }}/.config/karabiner/karabiner.json"
    force: no

- name: Install/update GSD (always runs for latest)
  ansible.builtin.command: npx get-shit-done-cc@latest --global
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
