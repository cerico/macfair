---
- name: Create claude directory
  file:
    path: "~{{ macbook_user.stdout }}/.claude"
    state: directory

- name: Create MEMORY/State directory for location persistence
  file:
    path: "~{{ macbook_user.stdout }}/.claude/MEMORY/State"
    state: directory

- name: Copy CLAUDE.md
  copy:
    src: claude/config.md
    dest: ~{{ macbook_user.stdout }}/.claude/CLAUDE.md

- name: Copy ralph.md
  copy:
    src: claude/ralph.md
    dest: ~{{ macbook_user.stdout }}/.claude/ralph.md

- name: Copy Claude settings
  copy:
    src: claude/settings.json
    dest: ~{{ macbook_user.stdout }}/.claude/settings.json

- name: Copy statusline script
  copy:
    src: claude/statusline.sh
    dest: ~{{ macbook_user.stdout }}/.claude/statusline.sh
    mode: '0755'

- name: Copy Claude skills
  copy:
    src: claude/skills/
    dest: ~{{ macbook_user.stdout }}/.claude/skills/

- name: Copy Claude hooks
  copy:
    src: claude/hooks/
    dest: ~{{ macbook_user.stdout }}/.claude/hooks/
    mode: '0755'

- name: Copy Claude commands
  copy:
    src: claude/commands/
    dest: ~{{ macbook_user.stdout }}/.claude/commands/

- name: Create gemini directory
  file:
    path: "~{{ macbook_user.stdout }}/.gemini"
    state: directory

- name: Copy GEMINI.md
  copy:
    src: claude/config.md
    dest: ~{{ macbook_user.stdout }}/.gemini/GEMINI.md

- name: Get list of installed MCP servers
  ansible.builtin.shell: claude mcp list 2>/dev/null || echo ""
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  register: mcp_list
  changed_when: false

- name: Add Prisma MCP server
  ansible.builtin.shell: claude mcp add -s user prisma -- npx prisma mcp
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  when: "'prisma' not in mcp_list.stdout"
  ignore_errors: true

- name: Add Semgrep MCP server
  ansible.builtin.shell: claude mcp add -s user semgrep -- semgrep mcp
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  when: "'semgrep' not in mcp_list.stdout"
  ignore_errors: true

- name: Add voicemode marketplace
  ansible.builtin.shell: claude plugin marketplace add https://github.com/mbailey/claude-plugins
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  args:
    creates: "{{ ansible_env.HOME }}/.claude/plugins/marketplaces/mbailey"
  ignore_errors: true

- name: Install voicemode plugin
  ansible.builtin.shell: claude plugin install voicemode@mbailey
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  args:
    creates: "{{ ansible_env.HOME }}/.claude/plugins/cache/mbailey/voicemode"
  ignore_errors: true

- name: Install Kokoro TTS via voicemode
  ansible.builtin.shell: claude /voicemode:install kokoro
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  args:
    creates: "{{ ansible_env.HOME }}/.voicemode/services/kokoro"
  ignore_errors: true
