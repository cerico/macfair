---
- name: Copy debian
  copy:
    src: zsh/debian.zsh
    dest: ~{{ macbook_user.stdout }}/.zsh/debian.zsh

- name: Copy dokku
  copy:
    src: zsh/dokku.zsh
    dest: ~{{ macbook_user.stdout }}/.zsh/dokku.zsh

- name: Register ansible location
  become: false
  shell: command python3 -m site --user-base
  register: python_location

- name: Add ansible to path.
  lineinfile:
    path: ~/.zshrc
    line: export PATH="{{ python_location.stdout }}/bin:$PATH"

- name: remove old provider.json
  file:
    path: "~{{ macbook_user.stdout }}/provider.json"
    state: absent
  become: true
  become_user: root

- name: collect server info
  shell: "curl -H 'User-Agent: keycdn-tools:https://google.com' 'https://tools.keycdn.com/geo.json?host={{ ansible_default_ipv4.address }}' > ~{{ macbook_user.stdout }}/provider.json"
  become: true
  become_user: "{{ macbook_user.stdout }}"

- name: copy motd
  copy:
    src: motd
    dest: /etc/profile.d/motd.sh
  become: true
  become_user: root

- name: Add motd to path.
  lineinfile:
    path: ~/.zshrc
    line: sh /etc/profile.d/motd.sh

- name: register motd.sh exists
  stat:
    path: /etc/profile.d/motd.sh
  register: motd

- name: Conditionally Add motd to path.
  lineinfile:
    path: ~/.zshrc
    line: sh /etc/profile.d/motd.sh
  when: motd.stat.exists

- name: create empty tokens file only if one doesnt already exist
  copy:
    content: ""
    dest: ~{{ macbook_user.stdout }}/.zsh/tokens.zsh
    force: no

- name: create trial file for new functions if one doesn't already exist
  copy:
    content: "tinker(){\n  echo try out new functions here, not in main file\n}"
    dest: ~{{ macbook_user.stdout }}/.zsh/_trialling.zsh
    force: no

- name: copy js help file
  copy:
    src: help.js
    dest: ~{{ macbook_user.stdout }}/.zsh/help.js

- name: Remove stale rails source line from zshrc
  lineinfile:
    path: ~/.zshrc
    line: source $HOME/.zsh/rails
    state: absent
