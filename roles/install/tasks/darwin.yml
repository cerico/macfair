---
- name: install core packages
  become: true
  become_user: "{{ brew_user.stdout }}"
  homebrew:
    name:
      [
        "yt-dlp",
        "gh",
        "jq",
        "wget",
        "dnsmasq",
        "gcc",
        "openssl",
        "cmake",
        "git",
        "moreutils",
        "findutils",
        "gnupg",
        "grep",
        "screen",
        "pigz",
        "tree",
        "ffmpeg",
        "shared-mime-info",
        "nginx",
        "graphviz",
        "node@{{ node_version }}",
        "pnpm",
        "bun",
        "zsh",
        "zsh-completions",
        "zsh-autosuggestions",
        "zsh-syntax-highlighting",
        "direnv",
        "watch",
        "nmap",
        "htop",
        "tmux",
        "postgresql",
        "redis",
        "lima",
        "glow",
        "n",
        "repomix",
        "podman",
        "autossh",
        "act",
        "dopplerhq/cli/doppler",
        "stripe/stripe-cli/stripe",
        "wireguard-tools",
        "python",
        "ripgrep",
        "neonctl",
        "uv",
        "semgrep",
        "shellcheck",
        ]
    state: present

- name: install packages requiring macOS 11+
  become: true
  become_user: "{{ brew_user.stdout }}"
  homebrew:
    name:
      - "git-lfs"
    state: present
  when: ansible_distribution_version is version('11.0', '>=')

- name: Create directory for installed caskapps
  file:
    path: "~{{ brew_user.stdout }}/Applications"
    state: directory
    mode: 0775

- name: install cask apps
  become: true
  become_user: "{{ brew_user.stdout }}"
  homebrew_cask:
    name: "{{ item }}"
    state: present
  with_items:
    - "vlc"
    - "firefox"
    - "alfred"
    - "iterm2"
    - "vagrant"
    - "vagrant-manager"
    - "virtualbox"
    - "tunnelblick"
    - "slack"
    - "visual-studio-code"
    - "brave-browser"
    - "google-chrome"
    - "chromium"
    - "rar"
    - "karabiner-elements"
    - "opensuperwhisper"

- name: Copy zshenv
  copy:
    src: zshenv
    dest: ~{{ macbook_user.stdout }}/.zshenv

- name: source zshenv so we get /usr/local/bin for npm
  shell: source ~/.zshenv

- name: Install npm packages
  npm:
    name: "{{ item }}"
    global: yes
  with_items:
    - "vercel"
    - "netlify-cli"
    - "railway"
    - "ts-node"
    - "typescript"
    - "browser-sync"
    - "surge"

- name: pip installs
  pip:
    name: "{{ item }}"
  with_items:
    - "jmespath"
    - "passlib"
    - "yq"

- name: Check if Claude Code is installed
  stat:
    path: "~{{ macbook_user.stdout }}/.local/bin/claude"
  register: claude_installed

- name: Install Claude Code
  shell: curl -fsSL https://claude.ai/install.sh | bash
  when: not claude_installed.stat.exists

- name: link node
  shell: /opt/homebrew/bin/brew link --overwrite node@{{ node_version }}

